name: PR Checks (Fast)

on: [pull_request]

jobs:
  fast-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    services:
      postgres:
        image: ankane/pgvector:latest
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: research_kb_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e packages/contracts
          pip install -e packages/common
          pip install -e packages/storage
          pip install -e packages/s2-client
          pip install -e packages/extraction
          pip install -e packages/pdf-tools
          pip install -e packages/client
          pip install -e packages/dashboard
          pip install -e packages/api
          pip install -e packages/daemon
          pip install -e packages/mcp-server
          pip install -e packages/cli
          pip install pytest pytest-asyncio pytest-cov
          pip install black ruff mypy

      - name: Code quality checks
        run: |
          echo "=== Black (formatting) ==="
          black --check packages/ scripts/ tests/
          echo "=== Ruff (linting) ==="
          ruff check packages/ scripts/ tests/

      - name: Type check (baseline)
        run: python scripts/mypy_baseline_check.py

      - name: Unit tests (no external services)
        env:
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          POSTGRES_DB: research_kb_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        run: |
          pytest packages/ tests/ \
            -m "unit and not requires_embedding and not requires_ollama and not requires_reranker and not requires_grobid" \
            -v --tb=short \
            --cov=packages --cov-report=term-missing --cov-report=xml:coverage-unit.xml \
            --cov-fail-under=40

      - name: Integration tests (DB only)
        env:
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          POSTGRES_DB: research_kb_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          TEST_DATABASE_NAME: research_kb_test
        run: |
          pytest packages/ tests/ \
            -m "integration and not requires_embedding and not requires_ollama and not requires_reranker" \
            -v --tb=short \
            --cov=packages --cov-report=term-missing --cov-report=xml:coverage-integration.xml --cov-append \
            --cov-fail-under=40

      - name: Doc freshness gate
        run: |
          echo "=== Documentation Audit (fast checks) ==="
          python scripts/audit_docs.py --ci
          echo "=== Auto-generated sections check ==="
          python scripts/generate_readme_sections.py --check
